# FHIR Data Service é‡æ§‹ç¸½çµ

## ğŸ¯ é‡æ§‹ç›®æ¨™

å°‡åŸæœ¬ 1926 è¡Œçš„ `fhir_data_service.py` æ‹†åˆ†ç‚ºå¤šå€‹æ¨¡çµ„åŒ–çš„æœå‹™ï¼Œæé«˜å¯ç¶­è­·æ€§å’Œå¯æ¸¬è©¦æ€§ã€‚

## ğŸ“¦ æ–°çš„æ¨¡çµ„çµæ§‹

```
services/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ cdss_config_loader.py      # é…ç½®è¼‰å…¥å™¨ (~90 è¡Œ)
â”œâ”€â”€ unit_conversion.py          # å–®ä½è½‰æ›ç³»çµ± (~180 è¡Œ)
â”œâ”€â”€ fhir_utils.py               # FHIR é€šç”¨å·¥å…· (~210 è¡Œ)
â”œâ”€â”€ condition_checkers.py       # æ¢ä»¶æª¢æŸ¥å™¨ (~500 è¡Œ)
â”œâ”€â”€ fhir_client.py              # FHIR å®¢æˆ¶ç«¯ (~280 è¡Œ)
â”œâ”€â”€ precise_hbr_calculator.py   # PRECISE-HBR è¨ˆç®—å™¨ (~480 è¡Œ)
â””â”€â”€ tradeoff_calculator.py      # Tradeoff åˆ†æè¨ˆç®—å™¨ (~300 è¡Œ)

fhir_data_service.py            # ä¸»å…¥å£é» (~150 è¡Œï¼Œç°¡åŒ–ç‰ˆ)
```

## âœ… å·²å®Œæˆçš„æ¨¡çµ„

### 1. `services/cdss_config_loader.py`
**è·è²¬**: è¼‰å…¥å’Œç®¡ç† CDSS é…ç½®
**ä¸»è¦åŠŸèƒ½**:
- `load_cdss_config()` - è¼‰å…¥ cdss_config.json
- `get_cdss_config()` - ç²å–é…ç½®
- `get_loinc_codes()` - ç²å– LOINC codes
- `get_text_search_terms()` - ç²å–æ–‡å­—æœå°‹è©å½™

**å„ªå‹¢**:
- âœ… å–®ä¸€è·è²¬ï¼šåƒ…è™•ç†é…ç½®è¼‰å…¥
- âœ… å…¨åŸŸé…ç½®å¿«å–
- âœ… éŒ¯èª¤è™•ç†é›†ä¸­

### 2. `services/unit_conversion.py`
**è·è²¬**: é†«å­¸å¯¦é©—å®¤æ•¸å€¼çš„å–®ä½è½‰æ›
**ä¸»è¦åŠŸèƒ½**:
- `TARGET_UNITS` - æ¨™æº–å–®ä½å®šç¾©
- `get_value_from_observation()` - å–®ä½æ„ŸçŸ¥çš„æ•¸å€¼æå–
- `normalize_unit_string()` - å–®ä½å­—ä¸²æ¨™æº–åŒ–

**å„ªå‹¢**:
- âœ… å¯é‡ç”¨çš„è½‰æ›é‚è¼¯
- âœ… æ”¯æ´å¤šç¨®å–®ä½æ ¼å¼
- âœ… è©³ç´°çš„æ—¥èªŒè¨˜éŒ„

### 3. `services/fhir_utils.py`
**è·è²¬**: FHIR ç›¸é—œçš„é€šç”¨è¼”åŠ©å‡½æ•¸
**ä¸»è¦åŠŸèƒ½**:
- `get_patient_demographics()` - æå–æ‚£è€…äººå£çµ±è¨ˆè³‡æ–™
- `calculate_egfr()` - CKD-EPI 2021 eGFR è¨ˆç®—
- `resource_has_code()` - ç·¨ç¢¼åŒ¹é…
- `is_within_time_window()` - æ™‚é–“çª—å£æª¢æŸ¥
- `get_condition_text()` - æ¢ä»¶æ–‡å­—æå–
- `get_score_from_table()` - åˆ†æ•¸è¡¨æŸ¥æ‰¾
- `get_active_medications()` - æ´»èºè—¥ç‰©è­˜åˆ¥

**å„ªå‹¢**:
- âœ… å¯åœ¨å¤šå€‹è¨ˆç®—å™¨ä¸­é‡ç”¨
- âœ… æ¸…æ™°çš„å‡½æ•¸è·è²¬
- âœ… å®Œå–„çš„æ–‡ä»¶èªªæ˜

### 4. `services/condition_checkers.py`
**è·è²¬**: æª¢æŸ¥å„ç¨®é†«ç™‚æ¢ä»¶
**ä¸»è¦åŠŸèƒ½**:
- `check_oral_anticoagulation()` - æª¢æŸ¥å£æœæŠ—å‡åŠ‘
- `check_bleeding_diathesis_updated()` - æª¢æŸ¥å‡ºè¡€ç´ è³ª
- `check_prior_bleeding_updated()` - æª¢æŸ¥æ—¢å¾€å‡ºè¡€å²
- `check_liver_cirrhosis_portal_hypertension_updated()` - æª¢æŸ¥è‚ç¡¬åŒ–
- `check_active_cancer_updated()` - æª¢æŸ¥æ´»å‹•æ€§ç™Œç—‡
- `check_arc_hbr_factors()` - æª¢æŸ¥ ARC-HBR å› ç´ 
- `check_arc_hbr_factors_detailed()` - è©³ç´° ARC-HBR æª¢æŸ¥
- `check_bleeding_history()` - æª¢æŸ¥å‡ºè¡€å²

**å„ªå‹¢**:
- âœ… æ‰€æœ‰æ¢ä»¶æª¢æŸ¥é‚è¼¯é›†ä¸­
- âœ… çµ±ä¸€çš„é…ç½®é©…å‹•æ–¹æ³•
- âœ… æ˜“æ–¼æ¸¬è©¦å–®å€‹æ¢ä»¶

### 5. `services/fhir_client.py`
**è·è²¬**: FHIR è³‡æ–™ç²å–å’Œå®¢æˆ¶ç«¯ç®¡ç†
**ä¸»è¦åŠŸèƒ½**:
- `setup_fhir_client()` - è¨­ç½® FHIR å®¢æˆ¶ç«¯
- `fetch_patient_resource()` - ç²å–æ‚£è€…è³‡æº
- `fetch_observations_by_loinc()` - é€é LOINC ç²å–è§€å¯Ÿ
- `fetch_observations_by_text()` - é€éæ–‡å­—æœå°‹ç²å–è§€å¯Ÿ
- `fetch_conditions()` - ç²å–æ¢ä»¶è³‡æ–™

**å„ªå‹¢**:
- âœ… FHIR é€šä¿¡é‚è¼¯é›†ä¸­
- âœ… æ”¯æ´æ¸¬è©¦æ¨¡å¼å’Œç”Ÿç”¢æ¨¡å¼
- âœ… å®Œå–„çš„éŒ¯èª¤è™•ç†
- âœ… è‡ªå‹• timeout ç®¡ç†

## ğŸ¨ é‡æ§‹å„ªå‹¢

### 1. å¯ç¶­è­·æ€§æå‡
- **åŸæœ¬**: 1926 è¡Œå–®ä¸€æª”æ¡ˆï¼Œé›£ä»¥å°èˆª
- **ç¾åœ¨**: 7 å€‹å°ˆæ³¨çš„æ¨¡çµ„ï¼Œæ¯å€‹ < 500 è¡Œ
- **æ”¹å–„**: æ›´å®¹æ˜“æ‰¾åˆ°å’Œä¿®æ”¹ç‰¹å®šåŠŸèƒ½

### 2. å¯æ¸¬è©¦æ€§æå‡
- **åŸæœ¬**: å·¨å¤§çš„å‡½æ•¸é›£ä»¥å–®å…ƒæ¸¬è©¦
- **ç¾åœ¨**: å°å‹ã€å°ˆæ³¨çš„å‡½æ•¸æ˜“æ–¼æ¸¬è©¦
- **æ”¹å–„**: å¯ä»¥ç‚ºæ¯å€‹æ¨¡çµ„ç·¨å¯«ç¨ç«‹çš„æ¸¬è©¦

### 3. å¯é‡ç”¨æ€§æå‡
- **åŸæœ¬**: é‚è¼¯åˆ†æ•£ï¼Œé‡è¤‡ä»£ç¢¼å¤š
- **ç¾åœ¨**: æ¸…æ™°çš„æ¨¡çµ„é‚Šç•Œï¼Œæ˜“æ–¼é‡ç”¨
- **æ”¹å–„**: å…¶ä»–å°ˆæ¡ˆå¯ä»¥è¼•é¬†å°å…¥ç‰¹å®šæ¨¡çµ„

### 4. å¯è®€æ€§æå‡
- **åŸæœ¬**: éœ€è¦æ»¾å‹•æ•¸ç™¾è¡Œæ‰èƒ½ç†è§£æµç¨‹
- **ç¾åœ¨**: æ¯å€‹æ¨¡çµ„æœ‰æ¸…æ™°çš„è·è²¬èªªæ˜
- **æ”¹å–„**: æ–°é–‹ç™¼è€…å¯ä»¥å¿«é€Ÿä¸Šæ‰‹

### 5. æ“´å±•æ€§æå‡
- **åŸæœ¬**: æ·»åŠ æ–°åŠŸèƒ½æœƒè®“æª”æ¡ˆæ›´é¾å¤§
- **ç¾åœ¨**: å¯ä»¥è¼•é¬†æ·»åŠ æ–°æ¨¡çµ„è€Œä¸å½±éŸ¿ç¾æœ‰ä»£ç¢¼
- **æ”¹å–„**: æ”¯æŒæœªä¾†çš„åŠŸèƒ½æ“´å±•

## ğŸ“Š ä»£ç¢¼è¡Œæ•¸å°æ¯”

| æ¨¡çµ„ | è¡Œæ•¸ | è·è²¬ |
|------|------|------|
| `cdss_config_loader.py` | ~90 | é…ç½®ç®¡ç† |
| `unit_conversion.py` | ~180 | å–®ä½è½‰æ› |
| `fhir_utils.py` | ~210 | é€šç”¨å·¥å…· |
| `condition_checkers.py` | ~500 | æ¢ä»¶æª¢æŸ¥ |
| `fhir_client.py` | ~280 | FHIR å®¢æˆ¶ç«¯ |
| `precise_hbr_calculator.py` | ~480 | PRECISE-HBR |
| `tradeoff_calculator.py` | ~300 | Tradeoff åˆ†æ |
| **æ–°çš„ fhir_data_service.py** | ~150 | **ä¸»å…¥å£** |
| **ç¸½è¨ˆ** | **~2190** | **(å«æ¨¡çµ„åŒ–å¥½è™•)** |
| **åŸå§‹æª”æ¡ˆ** | **1926** | **(é›£ä»¥ç¶­è­·)** |

## ğŸ”„ é·ç§»ç­–ç•¥

### éšæ®µ 1: å‰µå»ºæ–°æ¨¡çµ„ âœ… (å·²å®Œæˆéƒ¨åˆ†)
- âœ… å‰µå»º `services/` ç›®éŒ„
- âœ… å¯¦ä½œæ ¸å¿ƒæ¨¡çµ„ï¼ˆ5/7 å®Œæˆï¼‰
- â³ å¯¦ä½œè¨ˆç®—å™¨æ¨¡çµ„ï¼ˆå¾…å®Œæˆï¼‰

### éšæ®µ 2: é‡æ§‹ä¸»æª”æ¡ˆ (å¾…å®Œæˆ)
- â³ ç°¡åŒ– `fhir_data_service.py` ç‚ºä¸»å…¥å£
- â³ å°å…¥æ–°æ¨¡çµ„
- â³ ç§»é™¤é‡è¤‡ä»£ç¢¼

### éšæ®µ 3: æ¸¬è©¦é©—è­‰ (å¾…å®Œæˆ)
- â³ é‹è¡Œç¾æœ‰æ¸¬è©¦
- â³ ä¿®å¾©ä»»ä½•å•é¡Œ
- â³ é©—è­‰åŠŸèƒ½å®Œæ•´æ€§

### éšæ®µ 4: æ–‡ä»¶æ›´æ–° (å¾…å®Œæˆ)
- â³ æ›´æ–° API æ–‡ä»¶
- â³ æ›´æ–°ä½¿ç”¨ç¯„ä¾‹
- â³ å‰µå»ºæ¨¡çµ„æ–‡ä»¶

## ğŸ’¡ ä½¿ç”¨ç¯„ä¾‹

### èˆŠæ–¹å¼ï¼ˆå–®ä¸€æª”æ¡ˆï¼‰
```python
from fhir_data_service import get_fhir_data, calculate_precise_hbr_score

# æ‰€æœ‰åŠŸèƒ½éƒ½åœ¨ä¸€å€‹å·¨å¤§çš„æª”æ¡ˆä¸­
data, error = get_fhir_data(server, token, patient_id, client_id)
score = calculate_precise_hbr_score(data, demographics)
```

### æ–°æ–¹å¼ï¼ˆæ¨¡çµ„åŒ–ï¼‰
```python
# å¯ä»¥é¸æ“‡æ€§å°å…¥éœ€è¦çš„åŠŸèƒ½
from services.fhir_client import setup_fhir_client
from services.precise_hbr_calculator import calculate_precise_hbr_score
from services.unit_conversion import get_value_from_observation, TARGET_UNITS

# æˆ–è€…ä½¿ç”¨çµ±ä¸€å…¥å£é»
from fhir_data_service import get_fhir_data

# æ›´æ¸…æ™°çš„è·è²¬åˆ†é›¢
client, is_test = setup_fhir_client(server, token, patient_id, client_id)
# ... ç²å–è³‡æ–™ ...
score = calculate_precise_hbr_score(data, demographics)
```

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å®Œæˆå‰©é¤˜æ¨¡çµ„**:
   - `precise_hbr_calculator.py` - PRECISE-HBR å®Œæ•´è¨ˆç®—é‚è¼¯
   - `tradeoff_calculator.py` - Tradeoff åˆ†æè¨ˆç®—

2. **é‡æ§‹ä¸»å…¥å£**:
   - ç°¡åŒ– `fhir_data_service.py`
   - ä½¿ç”¨æ–°æ¨¡çµ„é‡æ–°å¯¦ä½œ `get_fhir_data()`

3. **æ¸¬è©¦å’Œé©—è­‰**:
   - é‹è¡Œæ‡‰ç”¨ç¨‹å¼
   - é©—è­‰æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
   - ä¿®å¾©ä»»ä½•æ•´åˆå•é¡Œ

4. **æ¸…ç†**:
   - ç§»é™¤èˆŠçš„å‚™ä»½æª”æ¡ˆ
   - æ›´æ–°å°å…¥èªå¥
   - æ›´æ–°æ–‡ä»¶

## ğŸ“ æ³¨æ„äº‹é …

- âœ… æ‰€æœ‰æ–°æ¨¡çµ„éƒ½åŒ…å«å®Œæ•´çš„æ–‡ä»¶å­—ä¸²
- âœ… ä¿æŒå‘å¾Œå…¼å®¹æ€§
- âœ… ä½¿ç”¨ç›¸å°å°å…¥é¿å…å¾ªç’°ä¾è³´
- âœ… æ¯å€‹æ¨¡çµ„éƒ½å¯ä»¥ç¨ç«‹æ¸¬è©¦
- âœ… é…ç½®é©…å‹•çš„è¨­è¨ˆæ›´éˆæ´»

## ğŸ‰ é æœŸæˆæœ

é‡æ§‹å®Œæˆå¾Œï¼Œå°‡ç²å¾—ï¼š
1. **æ›´å¥½çš„ä»£ç¢¼çµ„ç¹”** - æ¸…æ™°çš„æ¨¡çµ„è·è²¬
2. **æ›´å®¹æ˜“ç¶­è­·** - å°è€Œå°ˆæ³¨çš„å‡½æ•¸
3. **æ›´å®¹æ˜“æ¸¬è©¦** - ç¨ç«‹çš„æ¨¡çµ„
4. **æ›´å®¹æ˜“æ“´å±•** - æ·»åŠ æ–°åŠŸèƒ½ä¸å½±éŸ¿èˆŠä»£ç¢¼
5. **æ›´å¥½çš„é–‹ç™¼é«”é©—** - æ–°é–‹ç™¼è€…å¯ä»¥å¿«é€Ÿç†è§£æ¶æ§‹

