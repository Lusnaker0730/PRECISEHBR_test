{% extends "layout.html" %}

{% block title %}Test Patients List - Development Mode{% endblock %}

{% block content %}
<style>
    .test-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 2rem;
    }
    .patient-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
        background: white;
    }
    .patient-card:hover {
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
        border-color: #0d6efd;
    }
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }
</style>

<div class="container mt-4">
    <div class="test-warning">
        <h5>âš ï¸ é–‹ç™¼/æ¸¬è©¦æ¨¡å¼</h5>
        <p class="mb-0">
            æ­¤é é¢åƒ…ä¾›é–‹ç™¼å’Œæ¸¬è©¦ä½¿ç”¨ã€‚é€™äº›æ˜¯å¾ FHIR æœå‹™å™¨ç²å–çš„æ‚£è€…åˆ—è¡¨ã€‚
            <strong>è«‹å‹¿åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</strong>
        </p>
    </div>

    <h2 class="mb-4">æ¸¬è©¦æ‚£è€…åˆ—è¡¨ (éš¨æ©Ÿ 50 ä½)</h2>
    
    <!-- Server Info -->
    <div class="card mb-4">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted me-2">ä¾†æºæœå‹™å™¨:</span>
                    <span class="badge bg-primary">{{ fhir_server }}</span>
                </div>
                <div>
                    <a href="{{ url_for('views.test_patients_list') }}" class="btn btn-sm btn-outline-secondary">
                        ğŸ”„ é‡æ–°éš¨æ©Ÿç²å–
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        <strong>éŒ¯èª¤ï¼š</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Patient List Container -->
    <div id="patientList">
        {% for patient in patients %}
        <div class="patient-card" data-page="{{ (loop.index0 // 10) + 1 }}">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h5 class="mb-0">{{ patient.name }}</h5>
                    <small class="text-muted">ID: {{ patient.id }}</small>
                </div>
                <div class="col-md-3">
                    <span>{{ patient.gender }}</span>
                    <br>
                    <small class="text-muted">ç”Ÿæ—¥: {{ patient.birthDate }}</small>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">{{ patient.description }}</small>
                </div>
                <div class="col-md-2 text-end">
                    <a href="{{ url_for('views.test_mode') }}?patient_id={{ patient.id }}&server={{ fhir_server }}" 
                       class="btn btn-success btn-sm">
                        ğŸš€ é¸æ“‡æ­¤æ‚£è€…
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if patients|length == 0 and not error %}
    <div class="alert alert-warning">
        æœªæ‰¾åˆ°ä»»ä½•æ‚£è€…æ•¸æ“šã€‚
    </div>
    {% endif %}

    <!-- Pagination Controls -->
    <div class="pagination-container">
        <nav aria-label="Patient list navigation">
            <ul class="pagination" id="pagination">
                <!-- Generated by JS -->
            </ul>
        </nav>
    </div>
    
    <div class="text-center mt-3 text-muted small">
        é¡¯ç¤ºç¬¬ <span id="currentPageDisplay">1</span> é ï¼Œå…± <span id="totalPagesDisplay">5</span> é 
        (ç¸½è¨ˆ {{ patients|length }} ä½æ‚£è€…)
    </div>

    <div class="mt-4">
        <a href="/test-patients" class="btn btn-link text-muted">â† è¿”å›æ‰‹å‹•è¼¸å…¥æ¨¡å¼</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const itemsPerPage = 10;
        const totalItems = {{ patients|length }};
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        let currentPage = 1;

        function showPage(page) {
            // Update state
            currentPage = page;
            
            // Hide all items
            document.querySelectorAll('.patient-card').forEach(card => {
                card.style.display = 'none';
            });
            
            // Show items for current page
            document.querySelectorAll(`.patient-card[data-page="${page}"]`).forEach(card => {
                card.style.display = 'block';
            });
            
            // Update display text
            document.getElementById('currentPageDisplay').textContent = page;
            document.getElementById('totalPagesDisplay').textContent = totalPages;
            
            // Re-render pagination
            renderPagination();
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // Previous Button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); changePage(${currentPage - 1})">ä¸Šä¸€é </a>`;
            pagination.appendChild(prevLi);
            
            // Page Numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next Button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); changePage(${currentPage + 1})">ä¸‹ä¸€é </a>`;
            pagination.appendChild(nextLi);
        }

        // Make changePage available globally
        window.changePage = function(page) {
            if (page < 1 || page > totalPages) return;
            showPage(page);
        }

        // Initial Render
        if (totalItems > 0) {
            showPage(1);
        }
    });
</script>
{% endblock %}

