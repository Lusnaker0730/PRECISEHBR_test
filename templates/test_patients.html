{% extends "layout.html" %}

{% block title %}Test Patients - Development Mode{% endblock %}

{% block content %}
<style>
    .test-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 2rem;
    }
    .direct-input-card {
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e9 100%);
        border: 2px solid #28a745;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.15);
        padding: 2rem;
    }
    .direct-input-card:hover {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
    }
    .patient-id-input {
        font-family: 'Courier New', monospace;
        font-weight: 500;
        font-size: 1.2rem;
    }
</style>

<div class="container mt-4">
    <div class="test-warning">
        <h5>âš ï¸ é–‹ç™¼/æ¸¬è©¦æ¨¡å¼</h5>
        <p class="mb-0">
            æ­¤é é¢åƒ…ä¾›é–‹ç™¼å’Œæ¸¬è©¦ä½¿ç”¨ã€‚
            <strong>è«‹å‹¿åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</strong>
        </p>
    </div>

    <h2 class="mb-4">å…§éƒ¨æ¸¬è©¦é€£æ¥</h2>
    
    <!-- Server Info -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="card-title">ç›®æ¨™ FHIR æœå‹™å™¨</h6>
            <p class="card-text">
                <span class="badge bg-primary p-2" style="font-size: 1em;">{{ fhir_server }}</span>
            </p>
            <small class="text-muted">
                æ­¤é é¢å·²é…ç½®ç‚ºé€£æ¥åˆ°ä¸Šè¿°å…§éƒ¨æ¸¬è©¦æœå‹™å™¨ã€‚
            </small>
        </div>
    </div>

    <!-- Direct Patient ID Input -->
    <div class="card mb-4 direct-input-card">
        <div class="card-body">
            <h4 class="card-title text-success mb-3">
                ğŸ” è¼¸å…¥ Patient ID é€²è¡Œæ¸¬è©¦
            </h4>
            <p class="text-muted mb-4">
                è«‹è¼¸å…¥ä½æ–¼ <code>{{ fhir_server }}</code> ä¸Šçš„æ‚£è€… ID ä»¥å•Ÿå‹•æ‡‰ç”¨ã€‚
            </p>
            
            <form method="GET" action="{{ url_for('views.test_mode') }}" class="row g-3" id="patientIdForm">
                <input type="hidden" name="server" value="{{ fhir_server }}">
                <div class="col-md-9">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text">Patient ID</span>
                        <input type="text" 
                               class="form-control patient-id-input" 
                               name="patient_id" 
                               id="patientIdInput"
                               placeholder="e.g. 12345"
                               required
                               autofocus>
                    </div>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        ğŸš€ å•Ÿå‹•æ¸¬è©¦
                    </button>
                </div>
            </form>
            
            <!-- Quick Patient ID Examples -->
            <div class="mt-3 pt-2 border-top">
                <small class="text-muted d-block mb-2"><strong>æœ€è¿‘ä½¿ç”¨ / å¸¸ç”¨ ID:</strong></small>
                <div class="d-flex flex-wrap gap-2" id="recentIds">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function fillPatientId(patientId) {
            document.getElementById('patientIdInput').value = patientId;
            document.getElementById('patientIdForm').submit();
        }
        
        // Manage Recent IDs
        const RECENT_IDS_KEY = 'recentPatientIds';
        
        function loadRecentIds() {
            const recentIds = JSON.parse(localStorage.getItem(RECENT_IDS_KEY) || '[]');
            const container = document.getElementById('recentIds');
            container.innerHTML = '';
            
            if (recentIds.length === 0) {
                container.innerHTML = '<span class="text-muted small">å°šç„¡æœ€è¿‘ä½¿ç”¨è¨˜éŒ„</span>';
                return;
            }
            
            recentIds.forEach(id => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm btn-outline-success';
                btn.textContent = id;
                btn.onclick = () => fillPatientId(id);
                container.appendChild(btn);
            });
            
            // Add clear button
            if (recentIds.length > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.type = 'button';
                clearBtn.className = 'btn btn-sm btn-link text-muted';
                clearBtn.textContent = 'æ¸…é™¤è¨˜éŒ„';
                clearBtn.onclick = () => {
                    localStorage.removeItem(RECENT_IDS_KEY);
                    loadRecentIds();
                };
                container.appendChild(clearBtn);
            }
        }
        
        document.getElementById('patientIdForm').addEventListener('submit', function() {
            const patientId = document.getElementById('patientIdInput').value.trim();
            if (!patientId) return;
            
            let recentIds = JSON.parse(localStorage.getItem(RECENT_IDS_KEY) || '[]');
            // Remove if exists (to move to top)
            recentIds = recentIds.filter(id => id !== patientId);
            // Add to front
            recentIds.unshift(patientId);
            // Limit to 5
            recentIds = recentIds.slice(0, 5);
            
            localStorage.setItem(RECENT_IDS_KEY, JSON.stringify(recentIds));
        });
        
        // Load on start
        window.addEventListener('load', loadRecentIds);
    </script>

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">å…¶ä»–é¸é …</h5>
            <div class="list-group list-group-flush">
                <a href="/standalone" class="list-group-item list-group-item-action">
                    <i class="bi bi-box-arrow-in-right"></i>
                    <strong>Standalone Launch</strong>
                    <span class="text-muted ms-2">- ä½¿ç”¨æ¨™æº– OAuth æµç¨‹ç™»å…¥</span>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
