{% extends "layout.html" %}

{% block title %}Software Documentation{% endblock %}

{% block content %}
<style>
    /* Custom styles for the documentation page */
    .docs-container {
        display: flex;
        gap: 2rem;
    }
    .docs-nav {
        position: sticky;
        top: 6rem; /* Adjust based on navbar height */
        align-self: flex-start;
        width: 220px;
        flex-shrink: 0;
    }
    .docs-nav .nav-link {
        color: #6c757d;
        padding: 0.5rem 1rem;
        border-left: 3px solid transparent;
    }
    .docs-nav .nav-link:hover {
        color: #0d6efd;
        background-color: #e9ecef;
    }
    .docs-nav .nav-link.active {
        color: #0d6efd;
        font-weight: 600;
        border-left: 3px solid #0d6efd;
    }
    .docs-content {
        flex-grow: 1;
        min-width: 0; /* Prevents flexbox overflow */
    }
    .docs-content h4 {
        color: #0d6efd;
        margin-top: 2rem;
        margin-bottom: 1rem;
        scroll-margin-top: 6rem; /* Offset for sticky nav */
    }
    .docs-content h4 i {
        margin-right: 0.75rem;
    }
    .docs-content code {
        background-color: #e9ecef;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-size: 90%;
    }
    .hero-banner {
        background-color: #e9ecef;
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
</style>

<div class="container-fluid mt-5">
    <div class="docs-container">
        <!-- Sticky Navigation Sidebar -->
        <nav class="docs-nav d-none d-lg-block">
            <ul class="nav flex-column" id="docs-sidebar">
                <li class="nav-item"><a class="nav-link" href="#introduction">Introduction</a></li>
                <li class="nav-item"><a class="nav-link" href="#core-features">Core Features</a></li>
                <li class="nav-item"><a class="nav-link" href="#how-to-use">How to Use</a></li>
                <li class="nav-item"><a class="nav-link" href="#tech-stack">Technical Stack</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="docs-content">
            <div class="hero-banner">
                <h1 class="display-5">PRECISE-HBR Score Calculator</h1>
                <p class="lead">A SMART on FHIR application for clinical decision support in assessing patient bleeding risk.</p>
            </div>

            <section id="introduction">
                <h4><i class="fas fa-rocket"></i>Introduction</h4>
                <p>The PRECISE-HBR Score Calculator is a web-based clinical decision support tool designed for healthcare professionals. It implements the <strong>PRECISE-HBR (Predicting Bleeding Complications in Patients Undergoing Stent Implantation and Subsequent Dual Antiplatelet Therapy)</strong> scoring model.</p>
                <p>This application connects to FHIR-compliant electronic health record (EHR) systems using the SMART on FHIR standard to automatically retrieve patient data and calculate the risk score, helping clinicians assess bleeding risk for patients after percutaneous coronary intervention (PCI).</p>
            </section>

            <section id="core-features">
                <h4><i class="fas fa-star"></i>Core Features</h4>
                <h5>PRECISE-HBR Score Calculation</h5>
                <p>The main feature of the application is the automated calculation of the PRECISE-HBR score. The tool fetches the following data points from the patient's record:</p>
                <ul>
                    <li><strong>Demographics:</strong> Age</li>
                    <li><strong>Lab Results:</strong> Hemoglobin, White Blood Cell (WBC) count, eGFR (or Creatinine for calculation)</li>
                    <li><strong>Medical History:</strong> Prior bleeding events, oral anticoagulation use, and other ARC-HBR factors.</li>
                </ul>
                <p>The application presents the total score, the corresponding risk level (e.g., Not High Bleeding Risk, HBR, Very HBR), and a component-by-component breakdown of the score. Users can also interactively modify values to see how they affect the final risk score.</p>
                
                <h5 class="mt-4">Bleeding vs. Ischemic Risk Trade-off Analysis</h5>
                <p>For patients identified with a high bleeding risk (PRECISE-HBR score â‰¥ 23), the application provides a link to an interactive trade-off analysis tool. This feature visualizes the balance between the patient's estimated 1-year bleeding risk and their ischemic/thrombotic risk based on a model of various clinical factors.</p>
                 <p>Clinicians can select or deselect risk factors to dynamically observe the impact on the patient's risk profile, aiding in shared decision-making regarding treatment strategies.</p>
            </section>

            <section id="how-to-use">
                <h4><i class="fas fa-directions"></i>How to Use the Application</h4>
                <h6>Standalone Launch (for testing or direct use):</h6>
                <ol>
                    <li>Navigate to the application's home page.</li>
                    <li>You will be presented with a "Standalone Launch" screen.</li>
                    <li>Enter the FHIR Server URL (the <code>iss</code> parameter) for the EHR system you wish to connect to. For example, for Cerner Sandbox, this would be <code>https://fhir-myrecord.cerner.com/r4/ec2458f2-1e24-41c8-b71b-0e701af7583d</code>.</li>
                    <li>Click "Launch".</li>
                    <li>You will be redirected to the EHR's login and authorization page.</li>
                    <li>After successfully authorizing the application, you will be redirected to the main risk calculation page, pre-filled with the selected patient's data.</li>
                </ol>
                <hr>
                <h6>EHR Launch (integrated use):</h6>
                <p>When the application is registered within an EHR system, clinicians can launch it directly from a patient's chart. The launch process is seamless, and the application will open directly to the risk calculation page for that patient.</p>
            </section>

            <section id="tech-stack">
                <h4><i class="fas fa-cogs"></i>Technical Stack</h4>
                <ul>
                    <li><strong>Backend:</strong> Python with Flask web framework.</li>
                    <li><strong>FHIR Integration:</strong> <code>fhirclient</code> library for Python, compliant with SMART on FHIR v2.</li>
                    <li><strong>Frontend:</strong> HTML, Bootstrap 5 for styling, and JavaScript with Chart.js for visualizations.</li>
                    <li><strong>Deployment:</strong> Configured for deployment on Google App Engine (Standard Environment for Python).</li>
                </ul>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Simple scrollspy for the docs navigation
    document.addEventListener('DOMContentLoaded', function () {
        const sections = document.querySelectorAll('.docs-content section');
        const navLinks = document.querySelectorAll('.docs-nav .nav-link');

        function onScroll() {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= sectionTop - 120) { // Adjust offset
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').substring(1) === current) {
                    link.classList.add('active');
                }
            });
        }

        window.addEventListener('scroll', onScroll);
        onScroll(); // Initial check
    });
</script>
{% endblock %}
