<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART on FHIR Launch - SMART 2.0</title>
    
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Cerner Smart Embeddable Lib CSS -->
    <link rel='stylesheet' type='text/css' href='/static/css/cerner-smart-embeddable-lib-1.7.0.min.css'>
    
    <style>
        .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            color: #333;
            max-width: 500px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }
        .smart-logo {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
        }
        .version-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .error-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="loading-container">
        <div class="card text-center">
            <div class="smart-logo mx-auto">
                <svg width="64" height="64" viewBox="0 0 256 256">
                    <circle cx="128" cy="128" r="118" fill="#f0f9ff" stroke="#2563eb" stroke-width="6"/>
                    <path d="M 50 128 A 78 78 0 0 1 206 128" fill="none" stroke-width="14" stroke="url(#logoGrad)" stroke-linecap="round"/>
                    <circle cx="65" cy="145" r="6" fill="#10b981"/>
                    <circle cx="128" cy="55" r="6" fill="#f59e0b"/>
                    <circle cx="191" cy="145" r="6" fill="#ef4444"/>
                    <defs>
                        <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#10b981"/>
                            <stop offset="50%" style="stop-color:#f59e0b"/>
                            <stop offset="100%" style="stop-color:#ef4444"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            
            <h3>SMART on FHIR Launch<span class="version-badge">v2.0</span></h3>
            <p class="text-muted">Initiating secure authentication with PKCE...</p>
            
            <div class="spinner-border text-primary mt-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            
            <div id="status-message" class="mt-3 text-info">
                Preparing SMART 2.0 authentication...
            </div>
            
            <div id="error-info" class="alert alert-danger mt-3" style="display: none;">
                <h5 class="alert-heading">Authentication Error</h5>
                <p id="error-message"></p>
                <div id="error-details" class="error-details" style="display: none;"></div>
                <hr>
                <p class="mb-0">
                    <small>Please try relaunching the application from your EHR system.</small>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Enhanced SMART 2.0 Launch Logic
        
        // Update status message
        function updateStatus(message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            console.log('SMART Launch Status:', message);
        }
        
        // Enhanced error handling
        function showError(message, details = null) {
            console.error('SMART Launch Error:', message);
            
            const errorDiv = document.getElementById('error-info');
            const errorMessage = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');
            
            errorMessage.textContent = message;
            
            if (details) {
                errorDetails.textContent = typeof details === 'string' ? details : JSON.stringify(details, null, 2);
                errorDetails.style.display = 'block';
            }
            
            errorDiv.style.display = 'block';
            document.querySelector('.spinner-border').style.display = 'none';
        }
        
        // Get URL parameters
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                iss: urlParams.get('iss'),
                launch: urlParams.get('launch')
            };
        }
        
        // SMART 2.0 Launch Process
        function initiateSmart2Launch() {
            const { iss, launch } = getUrlParameters();
            
            if (!iss) {
                showError('Missing required parameter: iss (issuer)');
                return;
            }
            
            updateStatus('Validating FHIR server...');
            
            // For SMART 2.0, we redirect to the backend to handle the complete flow
            // This ensures proper PKCE parameter coordination
            const backendLaunchUrl = new URL(window.location.origin + '/launch');
            backendLaunchUrl.searchParams.set('iss', iss);
            
            if (launch) {
                backendLaunchUrl.searchParams.set('launch', launch);
                updateStatus('Processing EHR launch token...');
            } else {
                updateStatus('Initiating standalone launch...');
            }
            
            // Add timestamp to prevent caching issues
            backendLaunchUrl.searchParams.set('_t', Date.now().toString());
            
            console.log('Redirecting to backend for SMART 2.0 launch:', backendLaunchUrl.toString());
            
            // Redirect to backend for unified SMART 2.0 handling
            setTimeout(() => {
                window.location.href = backendLaunchUrl.toString();
            }, 1000);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('SMART 2.0 Launch Page Loaded');
            updateStatus('Initializing SMART 2.0 authentication...');
            
            // Add a small delay to show the loading state
            setTimeout(() => {
                initiateSmart2Launch();
            }, 500);
        });
        
        // Handle any unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showError('Unexpected error during authentication', event.reason);
        });
    </script>
</body>
</html> 